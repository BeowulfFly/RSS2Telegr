# 翻译功能实现说明

## 功能概述

为 RSS2Telegr 项目添加了智能翻译功能,可以自动识别英文消息并使用 AI 模型翻译成中文。

## 实现方式

### 1. 核心模块: `ai/translator.js`

创建了新的翻译模块,包含以下功能:

- **语言检测** (`isEnglishDominant`): 
  - 统计文本中中文和英文字符的比例
  - 根据配置的阈值判断是否需要翻译
  - 默认阈值 0.2 (中文字符少于 20% 时翻译)

- **AI 翻译** (`translateToZh`):
  - 使用现有的 AI 客户端（DeepSeek/OpenAI）
  - 专业的翻译提示词,确保翻译质量
  - 保持原文格式（换行、列表、HTML 标签等）
  - 失败时自动降级到原文

- **批量翻译** (`translateBatch`):
  - 支持批量处理多条消息
  - 为未来扩展预留接口

### 2. 集成点: `publisher/channelPublisher.js`

在消息发布前添加翻译处理:

- **文本消息翻译**: `sendToChannel()` 函数
  - 发送前自动调用 `translateToZh()`
  - 翻译完成后再进行分段发送

- **图片说明翻译**: `sendPhotoToChannel()` 函数
  - 图片的 caption 也会自动翻译
  - 翻译后再进行长度限制处理

### 3. 配置项

添加了两个新的环境变量:

```bash
# 启用/禁用翻译功能
ENABLE_TRANSLATION=true

# 翻译阈值（0.0-1.0）
# 中文字符占比低于此值时翻译
TRANSLATION_THRESHOLD=0.2
```

## 文件变更清单

### 新增文件

1. `ai/translator.js` - 翻译核心模块
2. `test-translation.js` - 翻译功能测试脚本

### 修改文件

1. `publisher/channelPublisher.js`
   - 引入翻译模块
   - 在 `sendToChannel()` 中添加翻译
   - 在 `sendPhotoToChannel()` 中添加翻译

2. `.env` 和 `.env.example`
   - 添加 `ENABLE_TRANSLATION` 配置
   - 添加 `TRANSLATION_THRESHOLD` 配置

3. `README.md`
   - 功能特性中新增翻译说明
   - 配置说明中添加翻译配置章节
   - 常见问题中添加翻译相关 FAQ
   - 更新技术架构图

## 工作流程

```
消息输入
  ↓
语言检测 (isEnglishDominant)
  ↓
是英文? → 否 → 保持原文
  ↓ 是
AI 翻译 (translateToZh)
  ↓
翻译成功? → 否 → 使用原文
  ↓ 是
发送中文消息
```

## 使用示例

### 示例 1: 纯英文消息

**输入:**
```
Breaking News: OpenAI Releases GPT-5
The new model features improved reasoning capabilities.
```

**输出:**
```
突发新闻:OpenAI 发布 GPT-5
新模型具备改进的推理能力。
```

### 示例 2: 中文消息（不翻译）

**输入:**
```
最新消息:OpenAI 发布 GPT-5
新模型具有改进的推理能力。
```

**输出:** 保持原样

### 示例 3: 中英混合（根据阈值）

**输入:**
```
AI News: GPT-5 发布了
The model is impressive.
```

如果中文占比 > 20%: 不翻译
如果中文占比 < 20%: 翻译成中文

## 测试方法

运行测试脚本:

```bash
node test-translation.js
```

测试将验证:
1. 纯英文文本的翻译
2. 中文文本不被翻译
3. 中英混合文本的处理

## 成本估算

### DeepSeek (推荐)

- 输入: ¥0.001/1K tokens
- 输出: ¥0.002/1K tokens
- 单条消息约 300-800 tokens
- **成本: ¥0.001-0.003/条**

### GPT-4o-mini

- 输入: ¥0.015/1K tokens
- 输出: ¥0.060/1K tokens
- 单条消息约 300-800 tokens
- **成本: ¥0.01-0.03/条**

## 注意事项

1. **翻译质量**: 依赖 AI 模型质量,DeepSeek 的翻译质量已经非常好
2. **延迟**: 每条消息增加 1-3 秒翻译时间
3. **成本**: 使用 DeepSeek 成本极低,但需要注意 API 配额
4. **错误处理**: 翻译失败时自动降级到原文,不会影响消息发送
5. **格式保持**: 会尽量保持原文格式,包括换行、列表、HTML 标签等

## 后续优化建议

1. **缓存机制**: 
   - 相同内容不重复翻译
   - 使用 Redis 缓存翻译结果

2. **批量翻译**:
   - 多条消息合并成一次 API 调用
   - 降低 API 调用频率和成本

3. **多语言支持**:
   - 支持更多语言对（如日文、韩文等）
   - 自动识别源语言

4. **翻译质量优化**:
   - 针对不同类型内容使用不同提示词
   - 保留专业术语的英文原文

5. **用户控制**:
   - 添加命令允许用户查看原文
   - 支持手动触发翻译

## 技术亮点

✅ **零依赖**: 使用现有 AI 客户端,无需额外安装包
✅ **智能检测**: 自动识别语言,避免不必要的翻译
✅ **降级处理**: 翻译失败不影响消息发送
✅ **保持格式**: 翻译后保持原有格式结构
✅ **可配置**: 支持开关和灵敏度调节
✅ **低成本**: 使用 DeepSeek 成本极低
